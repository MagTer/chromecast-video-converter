services:
  orchestrator:
    build:
      context: ./services/orchestrator
      dockerfile: Dockerfile
    image: chromecast-video-converter/orchestrator:dev
    ports:
      - "9000:9000"
    volumes:
      - ./services/orchestrator/app:/app/app:ro
      - ./config:/app/config:ro
      - ./media:/watch:ro
      - ./logs:/app/logs
    depends_on:
      - redis
    environment:
      - PORT=9000
      - JOB_QUEUE=redis://redis:6379/0
      - CONFIG_PATH=/app/config/quality.sample.yaml

  folder-watcher:
    build:
      context: ./services/folder-watcher
      dockerfile: Dockerfile
    image: chromecast-video-converter/folder-watcher:dev
    depends_on:
      - orchestrator
    volumes:
      - ./media/movies:/watch/movies:ro
      - ./media/series:/watch/series:ro
    environment:
      - WATCH_ROOTS=movies:/watch/movies,series:/watch/series
      - ORCHESTRATOR_URL=http://orchestrator:9000
      - SCAN_INTERVAL=60

  gpu-ffmpeg:
    build:
      context: ./services/gpu-ffmpeg
      dockerfile: Dockerfile
    image: chromecast-video-converter/gpu-ffmpeg:dev
    gpus: all
    volumes:
    - ./media:/media
    - ./media:/watch
    - ./config:/app/config:ro
    environment:
    - FFMPEG_LOG_LEVEL=info
    - ORCHESTRATOR_URL=http://orchestrator:9000
    - NVIDIA_VISIBLE_DEVICES=all
    - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility

  redis:
    image: redis:7
    volumes:
      - redis_data:/data

volumes:
  redis_data:
