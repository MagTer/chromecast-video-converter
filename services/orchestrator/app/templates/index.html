<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chromecast Video Converter</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: rgba(15, 23, 42, 0.85);
      --accent: #2563eb;
      --text: #e5e7eb;
      --muted: #94a3b8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
      background-color: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
    }

    nav {
      background: #0b1220;
      border-right: 1px solid #1e293b;
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    nav h1 {
      font-size: 1.25rem;
      margin: 0;
    }

    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    nav a {
      display: block;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      border: 1px solid #1e293b;
      background: #0b1220;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    nav a:hover,
    nav a.active {
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.1);
    }

    nav .nav-hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
    }

    main {
      padding: 2rem 3rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .page {
      display: none;
      width: min(1200px, 100%);
    }

    .page.active {
      display: grid;
      gap: 1.25rem;
    }

    .page header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .page h2 {
      margin: 0;
      font-size: 1.35rem;
    }

    .page .subtitle {
      color: var(--muted);
      margin: 0;
    }

    .panel {
      background: var(--panel);
      border: 1px solid #1d4ed8;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 700;
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid #334155;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text);
    }

    th, td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .path-cell {
      word-break: break-all;
      white-space: normal;
      max-width: 520px;
    }

    th {
      color: var(--muted);
      font-weight: 600;
    }

    input, select, textarea {
      background: #0b1220;
      border: 1px solid #1e293b;
      border-radius: 0.5rem;
      color: var(--text);
      padding: 0.45rem 0.5rem;
      width: 100%;
    }

    .grid-two {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-weight: 700;
    }

    .status-running { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    .status-paused { background: rgba(252, 211, 77, 0.2); color: #fcd34d; }
    .status-idle { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }

    .log-list {
      min-height: 320px;
      max-height: 520px;
      overflow-y: auto;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      border: 1px solid #1e293b;
      border-radius: 0.5rem;
      padding: 0.75rem;
      background: #0b1220;
    }

    .log-entry { margin: 0; padding: 0.35rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-meta { color: var(--muted); font-size: 0.85rem; }
    .log-message { margin-top: 0.15rem; }

    .queue-actions { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
    .queue-actions #queue-status { margin-left: auto; }
    .queue-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .hint { color: var(--muted); font-size: 0.9rem; }
    .stacked { display: grid; gap: 0.5rem; }
  </style>
</head>
<body>
  <nav>
    <div>
      <h1>Chromecast Converter</h1>
      <p class="nav-hint">Queue management opens by default.</p>
    </div>
    <ul>
      <li><a href="#queue" data-page="queue" class="active">Queue management</a></li>
      <li><a href="#logs" data-page="logs">Logs</a></li>
      <li><a href="#config" data-page="config">Configuration</a></li>
    </ul>
  </nav>
  <main>
    <section class="page active" data-page="queue">
      <header>
        <div>
          <h2>Queue management</h2>
          <p class="subtitle">Control scans, job intake, and worker state.</p>
        </div>
        <div class="queue-actions">
          <div class="queue-buttons">
            <button id="scan-movies" type="button">Scan Movies</button>
            <button id="scan-series" type="button">Scan Series</button>
            <button id="pause-toggle" type="button">Pause</button>
          </div>
          <span id="queue-status" class="status-pill status-idle">Loading…</span>
        </div>
      </header>
      <p id="scan-result" class="hint"></p>
      <div class="panel">
        <header>
          <div>
            <h3 style="margin:0">Job queue</h3>
            <p class="hint" style="margin:0">Newest jobs appear first.</p>
          </div>
        </header>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Path</th>
              <th>Profile</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody id="job-rows"></tbody>
        </table>
      </div>
    </section>

    <section class="page" data-page="logs">
      <header>
        <div>
          <h2>Logs</h2>
          <p class="subtitle">Inspect worker and orchestrator output.</p>
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <select id="log-category">
            <option value="">All categories</option>
          </select>
          <select id="log-level">
            <option value="">All levels</option>
            <option value="INFO" selected>INFO</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
            <option value="VERBOSE">VERBOSE</option>
          </select>
          <input id="log-query" placeholder="Filter by text" />
          <button id="refresh-logs" type="button">Filter</button>
        </div>
      </header>
      <div class="panel">
        <div class="log-list" id="log-list"></div>
      </div>
    </section>

    <section class="page" data-page="config">
      <header>
        <div>
          <h2>Encoding configuration</h2>
          <p class="subtitle">Values are constrained to Chromecast Gen 2 capabilities.</p>
        </div>
      </header>
      <div class="panel">
        <form id="config-form">
          <div class="grid-two">
            <label>
              Profile
              <select id="profile-select"></select>
            </label>
            <label>
              H.264 profile
              <select id="profile-tier">
                <option value="baseline">Baseline</option>
                <option value="main">Main</option>
                <option value="high">High</option>
              </select>
            </label>
            <label>
              Level
              <select id="profile-level">
                <option value="3.1">3.1</option>
                <option value="4.0">4.0</option>
                <option value="4.1">4.1</option>
              </select>
            </label>
            <label>
              Resolution
              <select id="profile-resolution">
                <option value="1280x720">1280x720</option>
                <option value="1920x1080">1920x1080</option>
              </select>
            </label>
            <label>
              Max FPS
              <select id="profile-maxfps">
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="30">30</option>
              </select>
            </label>
            <label>
              NVENC preset
              <select id="profile-preset">
                <option value="p1">p1 (slowest)</option>
                <option value="p2">p2</option>
                <option value="p3">p3</option>
                <option value="p4">p4</option>
                <option value="p5">p5</option>
                <option value="p6">p6</option>
                <option value="p7">p7 (fastest)</option>
              </select>
            </label>
            <label>
              Rate control
              <select id="profile-rc">
                <option value="vbr_hq">VBR HQ (recommended)</option>
                <option value="vbr">VBR</option>
                <option value="cbr">CBR</option>
              </select>
            </label>
            <label>
              Constant quality (CQ)
              <select id="profile-cq">
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="22">22</option>
                <option value="24">24</option>
                <option value="26">26</option>
                <option value="28">28</option>
              </select>
            </label>
            <label>
              Max bitrate (<=12M)
              <select id="profile-maxrate">
                <option value="6M">6M</option>
                <option value="8M">8M</option>
                <option value="10M">10M</option>
                <option value="12M">12M</option>
              </select>
            </label>
            <label>
              Buffer size (<=24M)
              <select id="profile-bufsize">
                <option value="12M">12M</option>
                <option value="16M">16M</option>
                <option value="20M">20M</option>
                <option value="24M">24M</option>
              </select>
            </label>
            <label>
              Audio bitrate (<=512k)
              <select id="profile-audio-bitrate">
                <option value="128k">128k</option>
                <option value="160k">160k</option>
                <option value="192k">192k</option>
                <option value="256k">256k</option>
                <option value="320k">320k</option>
              </select>
            </label>
            <label>
              Audio channels
              <select id="profile-audio-channels">
                <option value="2">Stereo (2)</option>
              </select>
            </label>
          </div>
          <div style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">
            <button type="submit">Save encoding profile</button>
            <span id="config-result" class="hint"></span>
          </div>
        </form>
      </div>
      <div class="panel">
        <header>
          <div>
            <h3 style="margin:0">Logging retention</h3>
            <p class="hint" style="margin:0">Centralized log storage across orchestrator and workers.</p>
          </div>
        </header>
        <form id="log-config-form" class="stacked">
          <div class="grid-two">
            <label>
              Retain logs (days)
              <input id="log-retention" type="number" min="1" max="90" value="7" />
            </label>
            <div>
              <p id="log-stats" class="hint" style="margin:0">Loading log stats…</p>
            </div>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <button type="submit">Save log settings</button>
            <span id="log-config-result" class="hint"></span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
    const navLinks = Array.from(document.querySelectorAll("nav a[data-page]"));
    const pages = Array.from(document.querySelectorAll(".page"));
    const jobRows = document.querySelector("#job-rows");
    const scanResult = document.querySelector("#scan-result");
    const queueStatus = document.querySelector("#queue-status");
    const pauseToggle = document.querySelector("#pause-toggle");
    const logList = document.querySelector("#log-list");
    const logCategory = document.querySelector("#log-category");
    const logLevel = document.querySelector("#log-level");
    const logQuery = document.querySelector("#log-query");
    const configResult = document.querySelector("#config-result");
    const logRetention = document.querySelector("#log-retention");
    const logConfigResult = document.querySelector("#log-config-result");
    const logStats = document.querySelector("#log-stats");

    let configCache = null;

    if (!logLevel.value) {
      logLevel.value = "INFO";
    }

    function ensureOption(select, value, label) {
      if (value === undefined || value === null) return;
      const stringValue = String(value);
      const exists = Array.from(select.options).some((option) => option.value === stringValue);
      if (!exists) {
        const option = document.createElement("option");
        option.value = stringValue;
        option.textContent = label || stringValue;
        select.appendChild(option);
      }
      select.value = stringValue;
    }

    function switchPage(pageName) {
      pages.forEach((page) => {
        page.classList.toggle("active", page.dataset.page === pageName);
      });
      navLinks.forEach((link) => {
        link.classList.toggle("active", link.dataset.page === pageName);
      });
      if (window.location.hash !== `#${pageName}`) {
        window.location.hash = `#${pageName}`;
      }
    }

    navLinks.forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        switchPage(event.currentTarget.dataset.page);
      });
    });

    window.addEventListener("hashchange", () => {
      const target = window.location.hash.replace("#", "") || "queue";
      switchPage(target);
    });

    async function fetchConfig() {
      const response = await fetch("/api/config");
      const config = await response.json();
      configCache = config;
      logRetention.value = config.logging?.retention_days ?? 7;
      const profileSelect = document.querySelector("#profile-select");
      profileSelect.innerHTML = "";
      Object.keys(config.profiles).forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        profileSelect.appendChild(option);
      });
      if (profileSelect.value) {
        loadProfile(profileSelect.value);
      }
    }

    function loadProfile(name) {
      if (!configCache) return;
      const profile = configCache.profiles[name];
      document.querySelector("#profile-select").value = name;
      ensureOption(document.querySelector("#profile-tier"), profile.profile);
      ensureOption(document.querySelector("#profile-level"), profile.level);
      ensureOption(document.querySelector("#profile-resolution"), profile.resolution);
      ensureOption(document.querySelector("#profile-maxfps"), profile.max_fps ?? 30);
      ensureOption(document.querySelector("#profile-preset"), profile.preset ?? "p5");
      ensureOption(document.querySelector("#profile-rc"), profile.rc ?? "vbr_hq");
      ensureOption(document.querySelector("#profile-cq"), profile.cq ?? 18);
      ensureOption(document.querySelector("#profile-maxrate"), profile.max_bitrate);
      ensureOption(document.querySelector("#profile-bufsize"), profile.bufsize);
      ensureOption(document.querySelector("#profile-audio-bitrate"), profile.audio.bitrate);
      ensureOption(document.querySelector("#profile-audio-channels"), profile.audio.channels ?? 2, "Stereo (2)");
    }

    async function fetchJobs() {
      const response = await fetch("/api/jobs");
      const jobs = await response.json();
      jobRows.innerHTML = "";
      jobs.sort((a, b) => (a.created_at > b.created_at ? -1 : 1));
      jobs.forEach((job) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${job.id.slice(0, 8)}</td>
          <td class="status-${job.status}">${job.status}</td>
          <td class="path-cell" title="${job.path}">${job.path}</td>
          <td>${job.profile}</td>
          <td>${job.progress}%</td>
        `;
        jobRows.appendChild(tr);
      });
    }

    async function enqueueLibraryScan(library) {
      scanResult.textContent = `Enqueuing ${library} scan...`;
      const response = await fetch("/api/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ library }),
      });
      const result = await response.json();
      if (response.ok) {
        scanResult.textContent = `Scan scheduled for: ${result.scheduled.join(", ")}`;
      } else {
        scanResult.textContent = `Scan failed: ${result.detail || "Unknown error"}`;
      }
    }

    async function refreshQueueState() {
      const response = await fetch("/api/queue/state");
      const state = await response.json();
      if (state.paused) {
        queueStatus.textContent = "Paused";
        queueStatus.className = "status-pill status-paused";
        pauseToggle.textContent = "Resume";
      } else {
        queueStatus.textContent = "Running";
        queueStatus.className = "status-pill status-running";
        pauseToggle.textContent = "Pause";
      }
    }

    function formatLogTimestamp(rawTimestamp) {
      const parsed = new Date(rawTimestamp);
      if (Number.isNaN(parsed.getTime())) {
        return rawTimestamp;
      }
      return parsed.toLocaleString(undefined, {
        dateStyle: "medium",
        timeStyle: "medium",
      });
    }

    async function fetchLogs() {
      const params = new URLSearchParams();
      if (logCategory.value) params.set("logger", logCategory.value);
      if (logLevel.value) params.set("level", logLevel.value);
      if (logQuery.value) params.set("query", logQuery.value);
      const response = await fetch(`/api/logs?${params.toString()}`);
      const entries = await response.json();
      logList.innerHTML = "";
      entries.forEach((entry) => {
        const container = document.createElement("div");
        container.className = "log-entry";
        container.innerHTML = `
          <div class="log-meta">${formatLogTimestamp(entry.timestamp)} • ${entry.level} • ${entry.logger}</div>
          <div class="log-message">${entry.message}</div>
        `;
        logList.appendChild(container);
      });
    }

    async function fetchLogCategories() {
      const response = await fetch("/api/logs/categories");
      const categories = await response.json();
      const existingSelection = logCategory.value;
      logCategory.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = "All categories";
      logCategory.appendChild(all);
      categories.forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        logCategory.appendChild(option);
      });
      if (existingSelection && categories.includes(existingSelection)) {
        logCategory.value = existingSelection;
      }
    }

    function formatBytes(bytes) {
      if (bytes === 0) return "0 B";
      const sizes = ["B", "KB", "MB", "GB", "TB"];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      const value = bytes / 1024 ** i;
      return `${value.toFixed(value >= 10 ? 0 : 1)} ${sizes[i]}`;
    }

    async function fetchLogStats() {
      const response = await fetch("/api/logs/stats");
      const stats = await response.json();
      logStats.textContent = `Stored ${stats.total_entries} entr${
        stats.total_entries === 1 ? "y" : "ies"
      } (${formatBytes(stats.file_size_bytes)}) with a ${stats.retention_days}-day retention window.`;
      if (!logRetention.value) {
        logRetention.value = stats.retention_days;
      }
    }

    document
      .querySelector("#scan-movies")
      .addEventListener("click", () => enqueueLibraryScan("movies"));
    document
      .querySelector("#scan-series")
      .addEventListener("click", () => enqueueLibraryScan("series"));

    pauseToggle.addEventListener("click", async () => {
      const paused = pauseToggle.textContent === "Resume";
      if (paused) {
        await fetch("/api/queue/resume", { method: "POST" });
      } else {
        const reason = prompt("Reason for pausing? (optional)", "") || "";
        await fetch("/api/queue/pause", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reason }),
        });
      }
      await refreshQueueState();
    });

    document.querySelector("#refresh-logs").addEventListener("click", fetchLogs);
    logCategory.addEventListener("change", fetchLogs);

    document.querySelector("#profile-select").addEventListener("change", (event) => {
      loadProfile(event.target.value);
    });

    document.querySelector("#log-config-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      const retentionDays = Number(logRetention.value || "7");
      logConfigResult.textContent = "Saving...";
      const response = await fetch("/api/config/logging", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ retention_days: retentionDays }),
      });
      const result = await response.json();
      if (response.ok) {
        logConfigResult.textContent = `Retention updated to ${result.retention_days} days.`;
        fetchLogStats();
        fetchLogs();
      } else {
        logConfigResult.textContent = `Save failed: ${result.detail || "Unknown error"}`;
      }
    });

    document.querySelector("#config-form").addEventListener("submit", async (event) => {
      event.preventDefault();
      const profileName = document.querySelector("#profile-select").value;
      const payload = {
        name: profileName,
        codec: "h264",
        profile: document.querySelector("#profile-tier").value,
        level: document.querySelector("#profile-level").value,
        resolution: document.querySelector("#profile-resolution").value,
        max_fps: Number(document.querySelector("#profile-maxfps").value || "30"),
        max_bitrate: document.querySelector("#profile-maxrate").value,
        bufsize: document.querySelector("#profile-bufsize").value,
        preset: document.querySelector("#profile-preset").value,
        rc: document.querySelector("#profile-rc").value,
        cq: Number(document.querySelector("#profile-cq").value || "18"),
        audio: {
          codec: "aac",
          bitrate: document.querySelector("#profile-audio-bitrate").value,
          channels: Number(document.querySelector("#profile-audio-channels").value || "2"),
        },
      };
      configResult.textContent = "Saving...";
      const response = await fetch("/api/config/encoding", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await response.json();
      if (response.ok) {
        configResult.textContent = `Updated profile ${result.name}`;
        configCache.profiles[result.name] = result.profile;
      } else {
        configResult.textContent = `Save failed: ${result.detail}`;
      }
    });

    fetchConfig();
    fetchJobs();
    fetchLogCategories();
    fetchLogs();
    fetchLogStats();
    refreshQueueState();
    const initialPage = window.location.hash.replace("#", "") || "queue";
    switchPage(initialPage);
    setInterval(fetchJobs, 5000);
    setInterval(fetchLogs, 6000);
    setInterval(fetchLogCategories, 15000);
    setInterval(fetchLogStats, 20000);
    setInterval(refreshQueueState, 7000);
  </script>
</body>
</html>
