<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chromecast Video Converter</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
      color: #f5f5f5;
      background-color: #0f172a;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .panel {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid #1d4ed8;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-pending {
      color: #fcd34d;
    }

    .status-running {
      color: #34d399;
    }

    .status-completed {
      color: #86efac;
    }

    .status-failed {
      color: #f87171;
    }
  </style>
</head>
<body>
  <h1>Chromecast Video Converter</h1>
  <p>GPU-only transcoding for Chromecast Gen 2/3.</p>

  <div class="panel">
    <div>
      <strong>Manual scan</strong>
      <select id="library-select"></select>
      <button id="scan" type="button">Trigger scan</button>
    </div>
    <p id="scan-result"></p>
  </div>

  <div class="panel">
    <strong>Job queue</strong>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Path</th>
          <th>Profile</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody id="job-rows"></tbody>
    </table>
  </div>

  <script>
    const jobRows = document.querySelector("#job-rows");
    const librarySelect = document.querySelector("#library-select");
    const scanResult = document.querySelector("#scan-result");

    async function fetchConfig() {
      const response = await fetch("/api/config");
      const config = await response.json();
      librarySelect.innerHTML = "";
      Object.keys(config.libraries).forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = `${name} (${config.libraries[name].root})`;
        librarySelect.appendChild(option);
      });
    }

    async function fetchJobs() {
      const response = await fetch("/api/jobs");
      const jobs = await response.json();
      jobRows.innerHTML = "";
      jobs.sort((a, b) => (a.created_at > b.created_at ? -1 : 1));
      jobs.forEach((job) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${job.id.slice(0, 8)}</td>
          <td class="status-${job.status}">${job.status}</td>
          <td title="${job.path}">${job.path.slice(0, 40)}</td>
          <td>${job.profile}</td>
          <td>${job.progress}%</td>
        `;
        jobRows.appendChild(tr);
      });
    }

    document.querySelector("#scan").addEventListener("click", async () => {
      scanResult.textContent = "Enqueuing scan...";
      const library = librarySelect.value;
      const response = await fetch("/api/scan", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ library }),
      });
      const result = await response.json();
      scanResult.textContent = `Scan scheduled for: ${result.scheduled.join(", ")}`;
    });

    fetchConfig();
    fetchJobs();
    setInterval(fetchJobs, 5000);
  </script>
</body>
</html>
