<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Media Library</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">Media Library</h1>
        <form method="post" action="{{ url_for('manual_scan') }}">
          <button class="btn btn-outline-primary" type="submit">Rescan Library</button>
        </form>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}

      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">File Path</th>
              <th scope="col">Size (bytes)</th>
              <th scope="col">Status</th>
              <th scope="col">Output</th>
              <th scope="col">Retries</th>
              <th scope="col">Error</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for asset in pagination.items %}
            <tr>
              <td>{{ asset.id }}</td>
              <td class="text-break" style="min-width: 240px;">{{ asset.file_path }}</td>
              <td>{{ asset.file_size }}</td>
              <td>
                <span class="badge text-bg-{{ status_colors.get(asset.status, 'secondary') }}">
                  {{ asset.status }}
                </span>
              </td>
              <td class="text-break">{{ asset.output_path or '-' }}</td>
              <td>{{ asset.retry_count }}</td>
              <td class="text-break">{{ asset.error_log or '-' }}</td>
              <td>
                <form method="post" action="{{ url_for('reprocess', asset_id=asset.id) }}">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    type="submit"
                    {% if asset.status in [MediaStatus.Archived.value, MediaStatus.Processing.value] %}
                    disabled
                    {% endif %}
                  >
                    Re-process
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav aria-label="Page navigation">
        <ul class="pagination">
          {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('library', page=pagination.prev_num) }}">Previous</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</span>
          </li>

          {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('library', page=pagination.next_num) }}">Next</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </body>
</html>
